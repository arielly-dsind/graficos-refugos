<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Dashboard de Refugos</title>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
    }

    .filtros, .kpis {
      display: flex;
      gap: 20px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }

    .kpi {
      padding: 15px;
      border-radius: 8px;
      background: #f2f2f2;
      min-width: 150px;
      text-align: center;
    }

    canvas {
      margin: 40px 0;
    }
  </style>
</head>

<body>

<h1>ðŸ“Š Dashboard de Refugos</h1>

<!-- FILTROS -->
<div class="filtros">
  <div>
    <label>Data inÃ­cio</label><br>
    <input type="date" id="dataInicio">
  </div>

  <div>
    <label>Data fim</label><br>
    <input type="date" id="dataFim">
  </div>

  <div>
    <button onclick="atualizarDashboard()">Aplicar filtros</button>
  </div>
</div>

<!-- KPIs -->
<div class="kpis">
  <div class="kpi">
    <h3>Total Refugos</h3>
    <span id="kpiTotal">0</span>
  </div>

  <div class="kpi">
    <h3>Motivos</h3>
    <span id="kpiMotivos">0</span>
  </div>
</div>

<!-- GRÃFICOS -->
<canvas id="graficoMotivo"></canvas>
<canvas id="graficoPareto"></canvas>
<canvas id="graficoTempo"></canvas>

<script>
let dadosOriginais = [];
let graficoMotivo, graficoPareto, graficoTempo;

/* ========= FUNÃ‡Ã•ES BASE ========= */

function parseDataBR(dataStr) {
  const [dia, mes, ano] = dataStr.split("/");
  return new Date(ano, mes - 1, dia);
}

function carregarCSV() {
  Papa.parse("refugos.csv", {
    download: true,
    header: true,
    complete: function (resultado) {
      dadosOriginais = resultado.data.map(l => ({
        data: parseDataBR(l.data),
        motivo: l.motivo,
        quantidade: Number(l.quantidade)
      }));

      atualizarDashboard();
    }
  });
}

function aplicarFiltros() {
  const ini = document.getElementById("dataInicio").value;
  const fim = document.getElementById("dataFim").value;

  const dataIni = ini ? new Date(ini) : null;
  const dataFim = fim ? new Date(fim) : null;

  return dadosOriginais.filter(d =>
    (!dataIni || d.data >= dataIni) &&
    (!dataFim || d.data <= dataFim)
  );
}

function agruparPorMotivo(dados) {
  const mapa = {};
  dados.forEach(d => {
    mapa[d.motivo] = (mapa[d.motivo] || 0) + d.quantidade;
  });
  return mapa;
}

/* ========= DASHBOARD ========= */

function atualizarDashboard() {
  const dados = aplicarFiltros();

  atualizarKPIs(dados);
  graficoPorMotivo(dados);
  graficoParetoFunc(dados);
  graficoPorTempo(dados);
}

/* ========= KPIs ========= */

function atualizarKPIs(dados) {
  document.getElementById("kpiTotal").innerText =
    dados.reduce((s, d) => s + d.quantidade, 0);

  document.getElementById("kpiMotivos").innerText =
    new Set(dados.map(d => d.motivo)).size;
}

/* ========= GRÃFICO BASE ========= */

function graficoPorMotivo(dados) {
  const mapa = agruparPorMotivo(dados);

  if (graficoMotivo) graficoMotivo.destroy();

  graficoMotivo = new Chart(document.getElementById("graficoMotivo"), {
    type: "bar",
    data: {
      labels: Object.keys(mapa),
      datasets: [{
        label: "Quantidade",
        data: Object.values(mapa),
        backgroundColor: "#90caf9"
      }]
    }
  });
}

/* ========= PARETO ========= */

function graficoParetoFunc(dados) {
  const mapa = agruparPorMotivo(dados);
  const ranking = Object.entries(mapa).sort((a,b)=>b[1]-a[1]);

  let acumulado = 0;
  const total = ranking.reduce((s,[,v])=>s+v,0);

  const percentual = ranking.map(([_,v])=>{
    acumulado += v;
    return (acumulado/total*100).toFixed(2);
  });

  if (graficoPareto) graficoPareto.destroy();

  graficoPareto = new Chart(document.getElementById("graficoPareto"), {
    data: {
      labels: ranking.map(r=>r[0]),
      datasets: [
        {
          type: "bar",
          label: "Quantidade",
          data: ranking.map(r=>r[1]),
          backgroundColor: "#a5d6a7"
        },
        {
          type: "line",
          label: "% Acumulado",
          data: percentual,
          yAxisID: "y1"
        }
      ]
    },
    options: {
      scales: {
        y1: {
          position: "right",
          min: 0,
          max: 100
        }
      }
    }
  });
}

/* ========= ANÃLISE TEMPORAL ========= */

function graficoPorTempo(dados) {
  const mapa = {};

  dados.forEach(d=>{
    const chave = d.data.toISOString().slice(0,10);
    mapa[chave] = (mapa[chave] || 0) + d.quantidade;
  });

  if (graficoTempo) graficoTempo.destroy();

  graficoTempo = new Chart(document.getElementById("graficoTempo"), {
    type: "line",
    data: {
      labels: Object.keys(mapa),
      datasets: [{
        label: "Refugos por dia",
        data: Object.values(mapa),
        fill: false
      }]
    }
  });
}

carregarCSV();
</script>

</body>
</html>
