<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Dashboard de Refugos</title>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

<style>
body { font-family: Arial; margin: 20px; }
.filtros, .kpis { display: flex; gap: 20px; flex-wrap: wrap; }
.kpi { background: #f2f2f2; padding: 15px; border-radius: 8px; min-width: 150px; }
canvas { margin-top: 40px; }
</style>
</head>

<body>

<h1>ðŸ“Š Dashboard de Refugos</h1>

<!-- FILTROS -->
<div class="filtros">
  <div>
    <label>Data inÃ­cio</label><br>
    <input type="date" id="dataInicio">
  </div>

  <div>
    <label>Data fim</label><br>
    <input type="date" id="dataFim">
  </div>

  <button onclick="atualizarDashboard()">Aplicar filtros</button>
</div>

<!-- KPIs -->
<div class="kpis">
  <div class="kpi">
    <h3>Total Refugos</h3>
    <div id="kpiTotal">0</div>
  </div>
  <div class="kpi">
    <h3>Motivos</h3>
    <div id="kpiMotivos">0</div>
  </div>
</div>

<canvas id="graficoMotivo"></canvas>
<canvas id="graficoPareto"></canvas>
<canvas id="graficoTempo"></canvas>

<script>
let dadosOriginais = [];
let graficoMotivo, graficoPareto, graficoTempo;

/* ===== DATA COM HORA (DD/MM/YYYY HH:mm:ss) ===== */
function parseDataHora(valor) {
  if (!valor) return null;

  const [data, hora] = valor.trim().split(" ");
  const [d, m, y] = data.split("/");

  return new Date(y, m - 1, d);
}

/* ===== CARREGAR CSV ===== */
Papa.parse("refugos.csv", {
  download: true,
  skipEmptyLines: true,
  complete: function (res) {

    dadosOriginais = res.data
      .map(l => ({
        data: parseDataHora(l[0]),      // coluna 0 â†’ data_hora
        quantidade: Number(l[6]),       // coluna 6 â†’ quantidade
        motivo: l[8]                    // coluna 8 â†’ motivo
      }))
      .filter(l =>
        l.data &&
        l.motivo &&
        !isNaN(l.quantidade)
      );

    atualizarDashboard();
  }
});

/* ===== FILTRO DE DATA ===== */
function aplicarFiltros() {
  const ini = document.getElementById("dataInicio").value;
  const fim = document.getElementById("dataFim").value;

  const dataIni = ini ? new Date(ini) : null;
  const dataFim = fim ? new Date(fim) : null;

  return dadosOriginais.filter(d =>
    (!dataIni || d.data >= dataIni) &&
    (!dataFim || d.data <= dataFim)
  );
}

/* ===== AGRUPAMENTO ===== */
function agruparPorMotivo(dados) {
  const map = {};
  dados.forEach(d => {
    map[d.motivo] = (map[d.motivo] || 0) + d.quantidade;
  });
  return map;
}

/* ===== DASHBOARD ===== */
function atualizarDashboard() {
  const dados = aplicarFiltros();
  atualizarKPIs(dados);
  graficoMotivos(dados);
  graficoParetoFunc(dados);
  graficoTempoFunc(dados);
}

/* ===== KPIs ===== */
function atualizarKPIs(dados) {
  document.getElementById("kpiTotal").innerText =
    dados.reduce((s, d) => s + d.quantidade, 0);

  document.getElementById("kpiMotivos").innerText =
    new Set(dados.map(d => d.motivo)).size;
}

/* ===== GRÃFICO BASE ===== */
function graficoMotivos(dados) {
  const mapa = agruparPorMotivo(dados);
  if (graficoMotivo) graficoMotivo.destroy();

  graficoMotivo = new Chart(document.getElementById("graficoMotivo"), {
    type: "bar",
    data: {
      labels: Object.keys(mapa),
      datasets: [{
        label: "Quantidade",
        data: Object.values(mapa)
      }]
    }
  });
}

/* ===== PARETO ===== */
function graficoParetoFunc(dados) {
  const mapa = agruparPorMotivo(dados);
  const ord = Object.entries(mapa).sort((a,b)=>b[1]-a[1]);

  let acum = 0;
  const total = ord.reduce((s,[,v])=>s+v,0);

  if (graficoPareto) graficoPareto.destroy();

  graficoPareto = new Chart(document.getElementById("graficoPareto"), {
    data: {
      labels: ord.map(o=>o[0]),
      datasets: [
        { type:"bar", label:"Qtd", data: ord.map(o=>o[1]) },
        { type:"line", label:"% Acumulado", yAxisID:"y1",
          data: ord.map(o=>{
            acum+=o[1];
            return (acum/total*100).toFixed(1);
          })
        }
      ]
    },
    options:{
      scales:{ y1:{ position:"right", min:0, max:100 } }
    }
  });
}

/* ===== GRÃFICO TEMPORAL ===== */
function graficoTempoFunc(dados) {
  const map = {};
  dados.forEach(d=>{
    const k = d.data.toISOString().slice(0,10);
    map[k] = (map[k]||0)+d.quantidade;
  });

  if (graficoTempo) graficoTempo.destroy();

  graficoTempo = new Chart(document.getElementById("graficoTempo"), {
    type:"line",
    data:{
      labels:Object.keys(map),
      datasets:[{label:"Refugos por dia", data:Object.values(map)}]
    }
  });
}
</script>

</body>
</html>
