<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dashboard de Refugos - DS</title>

<link rel="icon" type="image/png" href="favicon.png">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>

:root{
--vermelho:#d90429;
--grafite:#1c1c1c;
--cinza:#2b2b2b;
--claro:#f4f6f9;
--card:#ffffff;
--texto:#111;
}

body{
margin:0;
font-family:'Segoe UI', sans-serif;
background:#f4f6f9;
transition:0.3s;
}

body.dark{
background:#121212;
color:white;
}

header{
background:var(--grafite);
color:white;
padding:15px 30px;
display:flex;
justify-content:space-between;
align-items:center;
}

header h1{
margin:0;
font-size:20px;
letter-spacing:1px;
}

.toggle{
background:var(--vermelho);
border:none;
color:white;
padding:8px 15px;
border-radius:20px;
cursor:pointer;
}

.container{
padding:30px;
}

textarea{
width:100%;
height:160px;
padding:10px;
border-radius:10px;
border:1px solid #ccc;
}

button{
padding:10px 20px;
border:none;
background:var(--vermelho);
color:white;
border-radius:6px;
cursor:pointer;
}

.filtros, .kpis{
display:flex;
gap:20px;
flex-wrap:wrap;
margin:20px 0;
}

.box{
background:white;
padding:20px;
border-radius:12px;
box-shadow:0 5px 15px rgba(0,0,0,0.05);
min-width:200px;
}

body.dark .box{
background:#1e1e1e;
}

canvas{
background:white;
padding:15px;
border-radius:12px;
margin-bottom:40px;
}

body.dark canvas{
background:#1e1e1e;
}

h2{
margin-top:40px;
}

</style>
</head>

<body>

<header>
<h1>Dashboard de Refugos - DS</h1>
<button class="toggle" onclick="alternarModo()">Modo Escuro</button>
</header>

<div class="container">

<textarea id="entrada"
placeholder="Cole aqui os dados do Excel respeitando as 11 colunas:
Data Apont. | Cód. Recurso | Cód. Usu. Apont. | Cód. Ordem | Cód. Produto | Nome Produto | Quantidade | Cód. Refugo | Nome Refugo | CLASSIFICAÇÃO | LINHA DO PRODUTO">
</textarea>

<br><br>
<button onclick="processar()">Gerar Relatório</button>

<div class="filtros box">
<div>
<label>Data Inicial</label><br>
<input type="date" id="dataInicio">
</div>

<div>
<label>Data Final</label><br>
<input type="date" id="dataFim">
</div>

<div style="align-self:end">
<button onclick="aplicarFiltro()">Aplicar Filtro</button>
</div>
</div>

<div class="kpis">
<div class="box">
Total Registros<br>
<b id="kpiRegistros">0</b>
</div>

<div class="box">
Total Quantidade<br>
<b id="kpiQuantidade">0</b>
</div>
</div>

<h2>Índice por Linha do Produto</h2>
<canvas id="grafLinha"></canvas>

<h2>Índice por Classificação</h2>
<canvas id="grafClassificacao"></canvas>

<h2>Índice por Nome do Refugo</h2>
<canvas id="grafRefugo"></canvas>

<h2>Índice por Código do Produto</h2>
<canvas id="grafProduto"></canvas>

<h2>Índice por Usuário (Operador)</h2>
<canvas id="grafUsuario"></canvas>

</div>

<script>

let dados = [];
let dadosFiltrados = [];
let graficos = {};

function alternarModo(){
document.body.classList.toggle("dark");
const btn = document.querySelector(".toggle");
btn.innerText = document.body.classList.contains("dark")
? "Modo Claro"
: "Modo Escuro";
}

function parseData(texto){
const [data,hora] = texto.split(" ");
const [d,m,a] = data.split("/");
return new Date(`${a}-${m}-${d}T${hora||"00:00:00"}`);
}

function processar(){
const texto = document.getElementById("entrada").value.trim();
if(!texto) return alert("Cole os dados");

dados = [];

texto.split("\n").forEach(linha=>{
const c = linha.split("\t");
if(c.length < 11) return;

dados.push({
data: parseData(c[0]),
recurso: c[1],
usuario: c[2],
ordem: c[3],
codProduto: c[4],
nomeProduto: c[5],
quantidade: Number(c[6].replace(",", ".")),
codRefugo: c[7],
nomeRefugo: c[8],
classificacao: c[9],
linhaProduto: c[10]
});
});

dadosFiltrados = [...dados];
atualizar();
}

function aplicarFiltro(){
const ini = document.getElementById("dataInicio").value;
const fim = document.getElementById("dataFim").value;

dadosFiltrados = dados.filter(d=>{
if(!d.data) return false;
if(ini && d.data < new Date(ini)) return false;
if(fim && d.data > new Date(fim+"T23:59:59")) return false;
return true;
});

atualizar();
}

function atualizar(){

document.getElementById("kpiRegistros").innerText = dadosFiltrados.length;

document.getElementById("kpiQuantidade").innerText =
dadosFiltrados.reduce((s,d)=>s+d.quantidade,0);

gerarGrafico("grafLinha","linhaProduto");
gerarGrafico("grafClassificacao","classificacao");
gerarGrafico("grafRefugo","nomeRefugo");
gerarGrafico("grafProduto","codProduto");
gerarGrafico("grafUsuario","usuario");

}

function gerarGrafico(canvasId, campo){

const mapa = {};
dadosFiltrados.forEach(d=>{
mapa[d[campo]] = (mapa[d[campo]]||0) + d.quantidade;
});

const ordenado = Object.entries(mapa)
.sort((a,b)=> b[1] - a[1]);

const labels = ordenado.map(item=>item[0]);
const valores = ordenado.map(item=>item[1]);

if(graficos[canvasId]) graficos[canvasId].destroy();

graficos[canvasId] = new Chart(document.getElementById(canvasId),{
type:"bar",
data:{
labels:labels,
datasets:[{
label:"Quantidade",
data:valores,
backgroundColor:"#d90429"
}]
},
options:{
responsive:true,
plugins:{legend:{display:false}}
}
});

}

</script>

</body>
</html>
