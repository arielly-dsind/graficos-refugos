<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>DS - Dashboard de Refugos</title>
<link rel="icon" type="image/png" href="logo.png">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
:root{
  --vermelho:#c40000;
  --grafite:#1f1f1f;
  --cinza:#f4f6f9;
  --branco:#ffffff;
}

body{
  margin:0;
  font-family:Arial, sans-serif;
  background:var(--cinza);
  transition:0.3s;
}

header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  padding:15px 30px;
  background:white;
  box-shadow:0 2px 5px rgba(0,0,0,0.1);
}

header img{
  height:40px;
}

.toggle{
  cursor:pointer;
  padding:8px 15px;
  border-radius:20px;
  border:1px solid #ccc;
  background:white;
}

.container{
  padding:30px 40px;
}

h1{
  color:var(--grafite);
}

textarea{
  width:100%;
  height:160px;
  padding:10px;
  border-radius:8px;
  border:1px solid #ccc;
}

button{
  padding:10px 20px;
  border:none;
  background:var(--vermelho);
  color:white;
  border-radius:6px;
  cursor:pointer;
  margin-right:10px;
}

.kpis{
  display:flex;
  gap:20px;
  flex-wrap:wrap;
  margin:20px 0;
}

.kpi{
  background:white;
  padding:20px;
  border-radius:10px;
  min-width:220px;
  box-shadow:0 3px 8px rgba(0,0,0,0.1);
}

canvas{
  background:white;
  border-radius:10px;
  padding:15px;
  margin-bottom:40px;
  box-shadow:0 3px 8px rgba(0,0,0,0.1);
}

/* DARK MODE */
.dark{
  background:var(--grafite);
  color:white;
}

.dark header{
  background:#2a2a2a;
}

.dark textarea{
  background:#333;
  color:white;
  border:none;
}

.dark .kpi{
  background:#2a2a2a;
}

.dark canvas{
  background:#2a2a2a;
}
</style>
</head>

<body>

<header>
<img src="logo.png">
<button class="toggle" onclick="alternarModo()">üåô</button>
</header>

<div class="container" id="areaRelatorio">

<h1>Dashboard de Refugos</h1>

<textarea id="entrada"
placeholder="Cole aqui os dados respeitando as 11 colunas"></textarea>
<br><br>
<button onclick="processar()">Gerar Relat√≥rio</button>
<button onclick="exportarPDF()">Exportar PDF</button>

<div class="kpis">
<div class="kpi">Total Registros<br><b id="kpiRegistros">0</b></div>
<div class="kpi">Total Quantidade<br><b id="kpiQuantidade">0</b></div>
</div>

<h2>√çndice por Linha do Produto</h2>
<canvas id="grafLinha"></canvas>

<h2>√çndice por Classifica√ß√£o</h2>
<canvas id="grafClassificacao"></canvas>

<h2>√çndice por Nome do Refugo</h2>
<canvas id="grafRefugo"></canvas>

<h2>√çndice por C√≥digo do Produto</h2>
<canvas id="grafProduto"></canvas>

<h2>√çndice por Usu√°rio</h2>
<canvas id="grafUsuario"></canvas>

</div>

<script>

let dados = [];
let graficos = {};

function alternarModo(){
document.body.classList.toggle("dark");
}

function processar(){
const texto = document.getElementById("entrada").value.trim();
if(!texto) return alert("Cole os dados");

dados = [];

texto.split("\n").forEach(linha=>{
const c = linha.split("\t");
if(c.length < 11) return;

dados.push({
linhaProduto:c[10],
classificacao:c[9],
nomeRefugo:c[8],
codProduto:c[4],
usuario:c[2],
quantidade:Number(c[6].replace(",", "."))
});
});

atualizar();
}

function atualizar(){
document.getElementById("kpiRegistros").innerText = dados.length;
document.getElementById("kpiQuantidade").innerText =
dados.reduce((s,d)=>s+d.quantidade,0);

gerarGrafico("grafLinha","linhaProduto");
gerarGrafico("grafClassificacao","classificacao");
gerarGrafico("grafRefugo","nomeRefugo");
gerarGrafico("grafProduto","codProduto");
gerarGrafico("grafUsuario","usuario");
}

function gerarGrafico(id,campo){

const mapa = {};
dados.forEach(d=>{
mapa[d[campo]] = (mapa[d[campo]]||0) + d.quantidade;
});

let ordenado = Object.entries(mapa)
.sort((a,b)=>b[1]-a[1]);

const labels = ordenado.map(x=>x[0]);
const valores = ordenado.map(x=>x[1]);

if(graficos[id]) graficos[id].destroy();

graficos[id] = new Chart(document.getElementById(id),{
type:"bar",
data:{
labels:labels,
datasets:[{
data:valores,
backgroundColor:"#c40000"
}]
},
options:{
responsive:true,
plugins:{legend:{display:false}},
scales:{y:{beginAtZero:true}}
}
});
}

async function exportarPDF(){
const { jsPDF } = window.jspdf;
const pdf = new jsPDF("p","mm","a4");

const area = document.getElementById("areaRelatorio");

await html2canvas(area).then(canvas=>{
const imgData = canvas.toDataURL("image/png");
const imgWidth = 190;
const pageHeight = 295;
const imgHeight = canvas.height * imgWidth / canvas.width;

pdf.addImage(imgData,"PNG",10,10,imgWidth,imgHeight);
pdf.save("Relatorio_Refugos_DS.pdf");
});
}

</script>

</body>
</html>
