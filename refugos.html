<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>DS - Dashboard de Refugos</title>
<link rel="icon" type="image/png" href="logo.png">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
:root{
--vermelho:#c40000;
--grafite:#1f1f1f;
--cinza:#f4f6f9;
}

body{
margin:0;
font-family:Arial;
background:var(--cinza);
transition:0.3s;
}

header{
display:flex;
justify-content:space-between;
align-items:center;
padding:15px 30px;
background:white;
box-shadow:0 2px 5px rgba(0,0,0,0.1);
}

.logo-area{
display:flex;
align-items:center;
gap:15px;
}

.logo-area img{
height:40px;
}

.toggle{
cursor:pointer;
padding:8px 15px;
border-radius:20px;
border:1px solid #ccc;
background:white;
}

.container{
padding:30px 40px;
}

textarea{
width:100%;
height:150px;
padding:10px;
border-radius:8px;
border:1px solid #ccc;
}

button{
padding:10px 20px;
border:none;
background:var(--vermelho);
color:white;
border-radius:6px;
cursor:pointer;
margin:5px 5px 5px 0;
}

.filtros{
background:white;
padding:20px;
border-radius:10px;
display:flex;
flex-wrap:wrap;
gap:15px;
margin:20px 0;
box-shadow:0 3px 8px rgba(0,0,0,0.1);
}

select,input[type=date]{
padding:8px;
border-radius:6px;
border:1px solid #ccc;
}

.kpis{
display:flex;
flex-wrap:wrap;
gap:20px;
margin:20px 0;
}

.kpi{
background:white;
padding:20px;
border-radius:10px;
min-width:200px;
box-shadow:0 3px 8px rgba(0,0,0,0.1);
}

canvas{
background:white;
border-radius:10px;
padding:15px;
margin-bottom:40px;
box-shadow:0 3px 8px rgba(0,0,0,0.1);
}

.dark{
background:#1f1f1f;
color:white;
}

.dark header{background:#2a2a2a;}
.dark textarea,.dark select,.dark input{background:#333;color:white;border:none;}
.dark .kpi,.dark .filtros,.dark canvas{background:#2a2a2a;}
</style>
</head>

<body>

<header>
<div class="logo-area">
<img src="logo.png">
<button onclick="voltar()">‚¨Ö Voltar</button>
</div>
<button class="toggle" onclick="alternarModo()">üåô</button>
</header>

<div class="container">

<h1>Dashboard de Refugos</h1>

<textarea id="entrada"
placeholder="Cole os dados respeitando as 11 colunas"></textarea><br><br>
<button onclick="processar()">Gerar Relat√≥rio</button>
<button onclick="exportarPDF()">Exportar PDF</button>

<div class="filtros">

<input type="date" id="fDataInicio">
<input type="date" id="fDataFim">

<select id="fOperador"><option value="">Operador</option></select>
<select id="fLinha"><option value="">Linha</option></select>
<select id="fProduto"><option value="">Produto</option></select>
<select id="fClassificacao"><option value="">Classifica√ß√£o</option></select>
<select id="fRefugo"><option value="">Refugo</option></select>

<button onclick="aplicarFiltros()">Aplicar</button>
<button onclick="limparFiltros()">Limpar</button>

</div>

<div class="kpis">
<div class="kpi">Total Registros<br><b id="kpiRegistros">0</b></div>
<div class="kpi">Total Quantidade<br><b id="kpiQuantidade">0</b></div>
<div class="kpi">M√©dia Di√°ria<br><b id="kpiMedia">0</b></div>
<div class="kpi">Operador Maior √çndice<br><b id="kpiOperador">-</b></div>
<div class="kpi">Motivo Maior √çndice<br><b id="kpiMotivo">-</b></div>
<div class="kpi">Classifica√ß√£o Maior √çndice<br><b id="kpiClassificacao">-</b></div>
</div>

<div id="graficosArea">
<h2>√çndice por Linha</h2><canvas id="grafLinha"></canvas>
<h2>√çndice por Classifica√ß√£o</h2><canvas id="grafClassificacao"></canvas>
<h2>√çndice por Refugo</h2><canvas id="grafRefugo"></canvas>
<h2>√çndice por Produto</h2><canvas id="grafProduto"></canvas>
<h2>√çndice por Operador</h2><canvas id="grafUsuario"></canvas>
</div>

</div>

<script>

let dados=[];
let dadosFiltrados=[];
let graficos={};

function voltar(){window.location.href="index.html";}
function alternarModo(){document.body.classList.toggle("dark");}

function parseData(t){
const [data]=t.split(" ");
const [d,m,a]=data.split("/");
return new Date(`${a}-${m}-${d}`);
}

function processar(){
const texto=document.getElementById("entrada").value.trim();
if(!texto)return alert("Cole os dados");

dados=[];

texto.split("\n").forEach(l=>{
const c=l.split("\t");
if(c.length<11)return;

dados.push({
data:parseData(c[0]),
usuario:c[2],
codProduto:c[4],
quantidade:Number(c[6].replace(",", ".")),
nomeRefugo:c[8],
classificacao:c[9],
linhaProduto:c[10]
});
});

popularFiltros();
dadosFiltrados=[...dados];
atualizar();
}

function popularSelect(id,campo){
const select=document.getElementById(id);
const valores=[...new Set(dados.map(d=>d[campo]).filter(v=>v))].sort();
select.innerHTML=`<option value="">${select.options[0].text}</option>`;
valores.forEach(v=>{
select.innerHTML+=`<option value="${v}">${v}</option>`;
});
}

function popularFiltros(){
popularSelect("fOperador","usuario");
popularSelect("fLinha","linhaProduto");
popularSelect("fProduto","codProduto");
popularSelect("fClassificacao","classificacao");
popularSelect("fRefugo","nomeRefugo");
}

function aplicarFiltros(){
const ini=document.getElementById("fDataInicio").value;
const fim=document.getElementById("fDataFim").value;

dadosFiltrados=dados.filter(d=>{
if(ini && d.data < new Date(ini)) return false;
if(fim && d.data > new Date(fim+"T23:59:59")) return false;
if(fOperador.value && d.usuario!==fOperador.value) return false;
if(fLinha.value && d.linhaProduto!==fLinha.value) return false;
if(fProduto.value && d.codProduto!==fProduto.value) return false;
if(fClassificacao.value && d.classificacao!==fClassificacao.value) return false;
if(fRefugo.value && d.nomeRefugo!==fRefugo.value) return false;
return true;
});

atualizar();
}

function limparFiltros(){
document.querySelectorAll(".filtros select, .filtros input").forEach(el=>el.value="");
dadosFiltrados=[...dados];
atualizar();
}

function atualizar(){

document.getElementById("kpiRegistros").innerText=dadosFiltrados.length;

const total=dadosFiltrados.reduce((s,d)=>s+d.quantidade,0);
document.getElementById("kpiQuantidade").innerText=total;

const dias=[...new Set(dadosFiltrados.map(d=>d.data.toISOString()))];
document.getElementById("kpiMedia").innerText=dias.length?(total/dias.length).toFixed(2):0;

calcularTop("usuario","kpiOperador");
calcularTop("nomeRefugo","kpiMotivo");
calcularTop("classificacao","kpiClassificacao");

gerarGrafico("grafLinha","linhaProduto");
gerarGrafico("grafClassificacao","classificacao");
gerarGrafico("grafRefugo","nomeRefugo");
gerarGrafico("grafProduto","codProduto");
gerarGrafico("grafUsuario","usuario");
}

function calcularTop(campo,id){
const mapa={};
dadosFiltrados.forEach(d=>{
mapa[d[campo]]=(mapa[d[campo]]||0)+d.quantidade;
});
let top=Object.entries(mapa).sort((a,b)=>b[1]-a[1])[0];
document.getElementById(id).innerText=top?`${top[0]} (${top[1]})`:"-";
}

function gerarGrafico(id,campo){

const mapa={};
dadosFiltrados.forEach(d=>{
mapa[d[campo]]=(mapa[d[campo]]||0)+d.quantidade;
});

let ordenado=Object.entries(mapa).sort((a,b)=>b[1]-a[1]);

const labels=ordenado.map(x=>x[0]);
const valores=ordenado.map(x=>x[1]);

if(graficos[id])graficos[id].destroy();

graficos[id]=new Chart(document.getElementById(id),{
type:"bar",
data:{
labels:labels,
datasets:[{data:valores,backgroundColor:"#c40000"}]
},
options:{
responsive:true,
plugins:{legend:{display:false}},
scales:{y:{beginAtZero:true,ticks:{precision:0}}}
}
});
}

async function exportarPDF(){
const { jsPDF }=window.jspdf;
const pdf=new jsPDF("p","mm","a4");
let y=10;

for(let id in graficos){
const canvas=document.getElementById(id);
const img=canvas.toDataURL("image/png");
pdf.addImage(img,"PNG",10,y,190,80);
y+=90;
if(y>250){pdf.addPage();y=10;}
}
pdf.save("Relatorio_DS.pdf");
}

</script>
</body>
</html>
